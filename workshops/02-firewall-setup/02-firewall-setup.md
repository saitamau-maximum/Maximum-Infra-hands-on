## この章でやること
- `ufw`コマンドを使って、ファイヤーウォールの設定をする
- `ssh`をパスワードではなく、公開鍵認証に設定する

## さあ、公開……の前に
あなたがサーバーを公開するためのてあれこれをやろうとしていると……
> 上司「あのさ、そのサーバー、セキュリティの設定した？」

首を振るあなた
> 上司「せてめてファイヤーウォールくらいはやってくれないと…」

---
**Firewall**とは、システムの内側と外側の境界の防火壁です。

基本的には、外→内の通信に対して、事前に用意した **許可リスト（Allowlist）** を照らし合わせ、リストにない通信を遮断する、という働きをします。

では早速、Firewallを設定していきましょう。

## UFWを使おう〜Firewall設定をカンタンに〜
ここでは、かなり簡略的な設定を行います。

もし、もっと細かい設定をしたい、もっと細かい仕様を知りたい、という方は各自で調べていただけたら幸いです。

あなたが上司からもらったサーバーはUbuntuだったので、`iptables`が使えそうです。

しかし、`iptables`は通信に対して非常に柔軟な操作が可能な一方、複雑になりやすいというデメリットがあります。

そこで、もっとカンタンに設定をするために`ufw`を利用しましょう。

おそらくデフォルトで入っていると思いますので、確認してみましょう。
```bash
sudo systemctl status ufw
```
動いていそうならOKです。

早速ufwを有効化……する前に。sshを許可するように許可リストに設定しておきましょう。

そうしないと、sshできなくなって操作が不可能になってしまいます。

```bash
sudo ufw allow 22
```
あるいは
```bash
sudo ufw allow ssh
```
これで、sshは許可されるようになりました。

前者のコマンドは22番ポートの通信を許可しています。

後者のコマンドはsshに必要なポートを許可しています。（22番ポートです）

※sshとポートの関係は`/etc/services`から取得されます。

これができたら、Firewallを有効化しましょう
```bash
sudo ufw enable
```
以下ような警告が出るかもしれませんが、先程許可リストに`ssh`を追加したので大丈夫なはず。`y`を押します
```
Command may disrupt existing ssh connections. Proceed with operation (y|n)? y
```
適用できたら、確認してみましょう。
```bash
sudo ufw status
```
このような画面が出てきたら成功です
```
Status: active

To                         Action      From
--                         ------      ----
22/tcp                     ALLOW       Anywhere
22/tcp (v6)                ALLOW       Anywhere (v6)
```

## 勝手にsshはされないのか？
現在、上司からもらったサーバーは22番ポート以外に向けた通信を拒否する設定になっています。

> 私「sshは開けても大丈夫なのかな……」

> N「パスワードがあるから大丈夫なんじゃないかな。多分……

その懸念は正しいです。現在は、ただsshを許可しているだけ、その認証はパスワードによって行われています。

今のままでは、大量のランダムパスワードを打ち込みまくることでパスワードを突破する、 **ブルートフォース攻撃** が可能になっています。

これに対する対策として、すぐに思いつくのは

- 接続頻度制限
- 公開鍵認証

の２つです。今回は、後者の設定をしてみましょう。

なお、公開鍵認証の詳しい仕組みは以下の記事を読んでみてください。

[https://clouddirect.jp.fujitsu.com/service/navi-words-ssh](https://clouddirect.jp.fujitsu.com/service/navi-words-ssh)

まずは、自分のパソコン（上司からもらったサーバーにリモートログインするためのPC）に、鍵を生成しましょう。

```bash
ssh-keygen -t ed25519
```

こうすると、PCの`~/.ssh`に`id_ed25519`と`id_ed25519.pub`という２つのファイルが追加されていると思います。これが、秘密鍵と公開鍵です。

**`.pub`ではないほう（秘密鍵）を公開したりすると、セキュリティ的に危険なので必ず秘密にしておいてください。**

次に、公開鍵（.pub）をサーバーに登録します。

今はまだパスワードによるリモートログインが可能だと思うので、
```bash
ssh-copy-id -i ~/.ssh/id_ed25519.pub [リモートユーザー名]@[リモートサーバーのipアドレス]
```
で、上司からもらったサーバーの`~/.ssh/authorized_keys`に自分の公開鍵を登録してしまいましょう。

これで、以降は
```bash
ssh -i ~/.ssh/id_ed25519 [リモートユーザー]@[リモートサーバーのipアドレス]
```
で、sshできるようになりました。

では、パスワード認証はいらなくなったので、やめましょう。

一旦リモートログインを解除してから、上記の方法でsshできることを確認します。

できたら、パスワード認証を無くすために設定ファイルを変更しましょう。

私の場合はvimを使っていますが、お好きなエディタを使ってください。
```bash
sudo vim /etc/ssh/sshd_config
```

おそらく
```
# PasswordAuthentication yes
```
でコメントアウトされているので、コメントアウトを外し、
```
PasswordAuthentication no
```
と書き換えてください。

書き終わったら、sshサーバーを再起動しましょう。
```bash
# 環境によってはsshではなくsshdを指定する必要があるかもしれません
sudo systemctl restart ssh
```
ここまですれば、sshを勝手にされるということはないでしょう。

お疲れ様でした！！

---

## おまけ 〜より強固な防護をめざして〜

### ufw によるアウトバウンド設定

ufwでは、外→内（インバウンド）の設定ではなく、内→外（アウトバウンド）の設定もすることができます。

具体的には、どの宛先ポートに対する通信を許可するかを設定することができます。

```bash
sudo ufw default deny outgoing
```
これで、すべてのアウトバウンド通信が制限されるようになりました。

「この状態では、Webアプリにアクセスしてきた人に返答できないのでは？」と思われるかもしれませんが、その部分は問題ありません。

一度外部から来た通信は一時的に`established`として管理され、双方向のやり取りが許可されます（iptablesの機能）。なので、我々が許可したポートを通してきたリクエストに関しては返答をすることができます。

とはいえ、それ以外のアウトバウンドの通信をすべて制限すると色々と不都合があります。

具体的には、名前解決ができなくなったり、外部のファイルを読み込んだりできなくなります（`apt`が使えなかったり…）

なので、運用する上で、最低限必要なものだけ開けておくのが良いでしょう。

```bash
sudo ufw allow out 53             # DNS
sudo ufw allow out 80/tcp         # HTTP
sudo ufw allow out 443/tcp        # HTTPS
```
他にも必要なボートがあったら開けておきましょう。

ちなみに、送信元のポートまで操作したり、宛先ポートの範囲指定をするなどの詳細設定をするには、`iptables`を直接利用する必要があります。

その際には、設定の重複によって意図しない挙動をしないようにufwを切りましょう。
### sshのポートを変える

通常、sshを受け付けるポートは22番ポートです。

### ポート番号についてひとつまみ
我々は、ポート番号を利用することで同時に複数の通信をすることができています。

通常は０〜65535の値をとります。

0〜1023は **Well Known Ports**と呼ばれ、特別扱いがされています。（よく、システムに必要なプロセスなどが割り当てられます）

一方それ以外をUser Portsとよび、その中でも登録管理しないことになっているのが **Dynamic Ports**（49152〜65535）です。

我々が通信をする際には、必ずPort対Portで通信を行います。一般には宛先ポートを定めたとき、自動的にDynamic Portsから空いているものを割り当てて、通信を行います。

### 実際に変更してみよう
sshを行う22番ポートもWell Known Portsの一つであり、その名の通りよく知られています。そのため、標的にされやすいポートでもあるわけです。

実は、sshを行うポートは変更することができます。これにより、少しセキュリティ的に強固になります。

**Ubuntuのバージョンによって設定の仕方が違います**

https://qiita.com/11ppm/items/a17e585e05cc3903f5c9#3%E6%97%A7%E6%96%B9%E5%BC%8F%E8%A8%AD%E5%AE%9A---ubuntu2204%E4%BB%A5%E5%89%8D

https://qiita.com/11ppm/items/a17e585e05cc3903f5c9#4%E6%96%B0%E6%96%B9%E5%BC%8F%E8%A8%AD%E5%AE%9A---ubuntu2210%E4%BB%A5%E9%99%8D

