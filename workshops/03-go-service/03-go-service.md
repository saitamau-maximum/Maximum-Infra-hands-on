## この章でやること
- systemdでGoサービスを管理する

## これ、もしかしてずっと手動でやるんですか？
あなたは、とりあえず環境構築を終え、
```
bash ./script/start-dev
```
を使ってシステムを仮稼働していました。

ある日のことです。

いつものようにNさんと仲良く研修に励んでいると、突然例の上司に声をかけられました。

> 上司「なんかサーバー落ちてたから再起動したんだけどさ、アプリが動かなくなっちゃった。」
> 
> あなた「あ、再起動したならまたGoとか起動し直さないと……」
> 
> 上司「落ちた原因も知りたいから、もしわかるなら後で報告してね。」

あなたはしぶしぶ自分のパソコンに向かいます。

まずsshして、次にアプリケーションを起動して……

これ、何かしらのアクシデントやメンテナンス停電のたびにやるのでしょうか。

それに、ログは標準出力に出ていたので、再起動されては見ることができません。

めんどくさい〜〜！！

そんなあなたにNさんが話しかけてきます。
> N「サービスファイルを作ると、楽になるんじゃないかな」

## サービスを作成しよう
Goアプリケーションをデプロイした後、手動で実行するのではなく、**systemd**を使用してバックグラウンドでサービスとして実行する方法があります。これにより、システムの起動時に自動でアプリケーションを開始できるようになります。

### まずはビルド
まず、Goアプリケーションをビルドし、実行可能なバイナリファイルを作成します。

```bash
# プロジェクトのルートディレクトリに移動
cd ~/Maximum-Infra-hands-on/backend

# バイナリをビルド
go build -o InfraHandsOn ./cmd/main.go
```
これにより、バイナリの実行ファイルが作成されました。

### Nが一晩でやってくれました

次に、サービスファイルを`/etc/systemd/system/`に作成しましょう

このディレクトリに同梱されている、Nさんが作成した`InfraHandsOn.service`を雛形に、サービスファイルを作成していきましょう。

まず最初に編集するべきは`ExecStart`です。
```bash
# アプリケーションの実行ファイルへのパスを指定。
ExecStart= # ビルドしたバイナリファイルが直下にある状態でpwdした結果/InfraHandsOn
```
ここは、実行ファイルへのパスを指定する場所なので、コメントアウトの通りにパスを埋めましょう

例
```bash
# アプリケーションの実行ファイルへのパスを指定。
ExecStart=/home/ubuntu/Maximum-Infra-hands-on/backend/InfraHandsOn
```
次に、ユーザーを指定します。
ユーザー名には、あなたが普段使っているときのコマンドラインに表示されているユーザーを入れてください。

ここを指定しない場合、rootユーザーによる実行になります。

次に、環境変数を変更して下さい。

この教材の01章でやったものと同様の変更です。

例
```bash
Environment=CORS_ORIGIN=http://localhost:5173
↓
Environment=CORS_ORIGIN=http://192.168.123.8:5173
```

最後に、ワーキングディレクトリを設定します。

Goアプリケーションのルートディレクトリを指定するので、先程バイナリファイルを指定したときのパスから、バイナリファイル名を消せばいいです。

例
```bash
WorkingDirectory=/home/ubuntu/Maximum-Infra-hands-on/backend
```

### 実行しましょう。
新しく作ったサービスをsystemdに認識させましょう
```bash
sudo systemctl daemon-reload
```

次に、サービスを開始します
```bash
sudo systemctl start InfraHandsOn.service
```

さらに、サーバー起動時に自動的にサービスを開始するようにしましょう
```bash
sudo systemctl enable InfraHandsOn.service
```

状態がどのようになっているか確認するには以下のコマンドを使います
```bash
sudo systemctl status InfraHandsOn.service
```

### ログが見れるって素晴らしい
サービス化したことによって、ログが標準出力以外でも確認できるようになりました。

```bash
journalctl -u InfraHandsOn.service
```

これであなたは、面倒な作業を毎回することなくGoアプリケーションを管理できるようになりました。

以上でこの章の内容は終了です。

お疲れ様でした。